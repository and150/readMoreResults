import constants
import datetime
import time
from datescompare import *

#################### вспомогательные функции и классы для списка испытаний ###########################
class WTItem:
    def __init__(self, well="", start = 0.0, stop = 0.0, wt = 0):    
        self.well = well     # well name
        self.wt = wt         # wt number
        self.start = start   # well test start
        self.stop = stop    # well test end  
    def printList(self):
        print(self.well, self.start, self.stop, self.wt)  


def GetWTlist(filename, SDAT): 
    WTLIST = []
    lines = [line.rstrip('\n') for line in open (filename)] 
    for x in lines:
        if len(x)>0: 
            words = x.split()
            WTLIST.append(    WTItem( words[0]  ,  date2days(words[1]+" "+words[2], SDAT), date2days(words[3]+" "+words[4], SDAT) , words[5]  )                 )
            #print (words[1]+" "+words[2]," | ", words[3]+" "+words[4])
    return WTLIST
 

def getWT(currDir, rootName, startDate, times, numsArray, RateOut):

    ResArr = RateOut[0]
    wellNames = RateOut[1]
    for i in range(0,len(wellNames)):
        wellNames[i] = wellNames[i].rstrip()


    wtFileName   = currDir+"\\"+rootName+".WTlist"  # имя входного файла со списком исследований
    outFile  = open(currDir+"\\"+rootName+".WTgraphs", "w") # выходной файл графиков исследований
    wtOutFile = open(currDir+"\\"+rootName+".WTout","w") # выходной файл с параметрами КВД
    wtOutFile.write("WTnumb  well startPBU LIQ  LIQH  BHP  BHPH  Press  PressH stopPBU\n") # заголовок таблицы параметров КВД        

    ####### обработка списка испытаний #######
    WTlist = GetWTlist(wtFileName, startDate)  #получает список испытаний скважин (нужно в программе научиться его сортировать по скважинам и по датам, но пока обязательно делать это перед загрузкой)
      

    #### поиск индекса скважины в массиве Item
    tr = 0
    timetol = constants.TIMETOL
    liqCut = constants.LIQCUT
    PBUstr = ""
    T = len(times) # количество записей RATE
    W = len(wellNames) # количество скважин
    MZ = numsArray[5-1] # количество слоев в скважинах (кол-во ячеек по вертикали, нужно сюда передавать параметр
    V = constants.VEC + MZ*2*numsArray[55-1]       # количество векторов 
    # vectors indexes
    Sopr  = constants.Sopr
    Swpr  = constants.Swpr 
    Sbhp  = constants.Sbhp
                 
    Sopt  = constants.Sopt  
    Swpt  = constants.Swpt  
    Swit  = constants.Swit  

    Hopr  = constants.Hopr  
    Hwpr  = constants.Hwpr  
    Hbhp  = constants.Hbhp  
    Hwefa = constants.Hwefa 


    for x in WTlist: # для всех скважино-испытаний в списке
        PBUstr = ""
        wi = (wellNames.index(x.well))     
        for i in range(0,T): # для всех временных записей RATE файла
            #вывод показателей только в интервале испытаний
            if(times[i]>= x.start and times[i]<= x.stop):             
            #if(x.start - times[i] < timetol and times[i] - x.stop < timetol):                
                #вывод всех показателей по испытаниям скважин в файл *.results  без фильтрации 
                outFile.write("\n")
                outFile.write("WT=" + str(x.wt)+ " ")                            #вывод номера испытания
                outStr = str(times[i]) +" " + str(wellNames[wi]+" "); outFile.write(outStr) # вывод времени и номера скважины                              

                outFile.write(str(ResArr[T*V*wi + T* Sbhp + i])); outFile.write(" ")  # вывод расчетного забойного давления                
                outFile.write(str(ResArr[T*V*wi + T* Sopr + i])); outFile.write(" ")  # вывод расчетного дебита нефти                
                outFile.write(str(ResArr[T*V*wi + T* Swpr + i])); outFile.write(" ")  # вывод расчетного дебита воды                

                outFile.write(str(ResArr[T*V*wi + T* Hbhp + i])); outFile.write(" ")  # вывод фактического забойного давления                
                outFile.write(str(ResArr[T*V*wi + T* Hopr + i])); outFile.write(" ")  # вывод фактического дебита нефти                
                outFile.write(str(ResArr[T*V*wi + T* Hwpr + i])); outFile.write(" ")  # вывод фактического дебита воды
                


                #поиск PBU и вытаскивание параметров для вывода в отдельную таблицу *.WTout
                # расчет дебитов жидкости в интервале PBU    
                currLiq  = ResArr[T*V*wi + T* Sopr + i] + ResArr[T*V*wi + T* Swpr + i] # текущий расчетный дебит жидкости
                currLiqH = ResArr[T*V*wi + T* Hopr + i] + ResArr[T*V*wi + T* Hwpr + i] # текущий фактический дебит жидкости


                currP  = ResArr[T*V*wi + T* Sbhp + i]   #расчетное давление 
                currPH = ResArr[T*V*wi + T* Hbhp + i]   #фактическое давление 
                if currP <= constants.PTOL or currPH <= constants.PTOL :
                    maxP = maxP
                    maxPH = maxPH
                else:
                    maxP = currP
                    maxPH = currPH


                if i<=len(times):  nextLiq = ResArr[T*V*wi + T* Sopr + i+1] + ResArr[T*V*wi + T* Swpr + i+1] # следующий расчетный дебит жидкости                   
                else: nextLiq = currLiq
    
                if(currLiq > liqCut):   # проверка интервалов с ненулевым дебитом 
                    outFile.write(" dynamic") 
                    if(nextLiq <= liqCut):                          
                        PBUstr = PBUstr + x.well + " " + str(times[i]) #имя скважины и время начала КВД
                        PBUstr = PBUstr + " " + str(currLiq) + " " + str(currLiqH) # расчетный и фактический дебит(приемистость) жидкости
                        PBUstr = PBUstr + " " + str(ResArr[T*V*wi + T* Sbhp + i]) #расчетное забойное 
                        PBUstr = PBUstr + " " + str(ResArr[T*V*wi + T* Hbhp + i])  #фактическое забойное
                else:
                    outFile.write(" static")                    
                    if(nextLiq > liqCut): 
                        #PBUstr = PBUstr + " " + str(ResArr[T*V*wi + T* Sbhp + i])   #расчетное пластовое
                        #PBUstr = PBUstr + " " + str(ResArr[T*V*wi + T* Hbhp + i])   #фактическое пластовое
                        #PBUstr = PBUstr + " " + str(maxP)   #расчетное пластовое
                        #PBUstr = PBUstr + " " + str(maxPH)   #фактическое пластовое
                        #PBUstr = PBUstr + " " + str(times[i])  # время окончания КВД                       
                        break # прерывает цикл после прочтения ПЕРВОЙ КВД для скважины!
        #print(str(x.wt)," ", PBUstr) # вывод параметров PBU в консоль
        PBUstr = PBUstr + " " + str(maxP)   #расчетное пластовое
        PBUstr = PBUstr + " " + str(maxPH)   #фактическое пластовое
        PBUstr = PBUstr + " " + str(times[i])  # время окончания КВД                       

        wtOutFile.write("WT="+str(x.wt)+" "+PBUstr+"\n") #вывод параметров PBU в файл        
    outFile.close()
    wtOutFile.close()
    ###### окончание обработки испытаний ######
